<!-- templates/analysis/start_analysis.html -->
{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="fas fa-search me-2 text-primary"></i>Start Analysis
        </h2>
        <div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#ruleSelectModal">
                <i class="fas fa-tasks me-1"></i> Select Rules
            </button>
        </div>
    </div>

    <div class="row">
        <!-- Incident Filter Column -->
        <div class="col-md-3 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Filter by Incident</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center active" 
                           id="filter-all" onclick="filterByIncident('all')">
                            All Incidents
                            <span class="badge bg-primary rounded-pill">{{ artefacts|length }}</span>
                        </a>
                        {% for incident in incidents %}
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" 
                           id="filter-{{ incident.id }}" onclick="filterByIncident({{ incident.id }})">
                            {{ incident.title|truncatechars:25 }}
                            <span class="badge bg-secondary rounded-pill">{{ incident.artefact_count }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Column -->
        <div class="col-md-9">
            <form id="analysis-form" onsubmit="launchAnalysisModal(event)">
                {% csrf_token %}
                
                <!-- Artefact Selection Card -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Select Artefact</h5>
                        <div class="d-flex gap-2">
                            <input type="text" class="form-control form-control-sm" placeholder="Search artefacts..." 
                                   id="artefact-search" style="width: 200px;">
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="selectAllArtefacts(true)">
                                    <i class="fas fa-check-square me-1"></i> All
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="selectAllArtefacts(false)">
                                    <i class="fas fa-square me-1"></i> None
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="artefact-table">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" class="form-check-input" id="select-all-checkbox">
                                        </th>
                                        <th>Artefact</th>
                                        <th>Incident</th>
                                        <th>Type</th>
                                        <th>Created</th>
                                        <th>Records</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for artefact in artefacts %}
                                    <tr class="artefact-row" data-incident="{{ artefact.incident.id }}">
                                        <td>
                                            <input type="checkbox" class="form-check-input artefact-checkbox" 
                                                   name="artefact_ids" value="{{ artefact.id }}">
                                        </td>
                                        <td>
                                            <strong>{{ artefact.name }}</strong>
                                            {% if artefact.description %}
                                            <p class="small text-muted mb-0">{{ artefact.description|truncatechars:50 }}</p>
                                            {% endif %}
                                        </td>
                                        <td>{{ artefact.incident.title|truncatechars:25 }}</td>
                                        <td><span class="badge bg-info">{{ artefact.get_type_display }}</span></td>
                                        <td>{{ artefact.created_at|date:"Y-m-d" }}</td>
                                        <td>{{ artefact.records.count }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-4">No artefacts assigned to you</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Rule Summary Card -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Selected Rules</h5>
                        <div>
                            <span class="badge bg-primary rounded-pill" id="selected-rule-count">0</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="selected-rules-container" class="d-flex flex-wrap gap-2">
                            <span class="text-muted">No rules selected</span>
                        </div>
                    </div>
                    <div class="card-footer d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary" id="run-analysis-btn" disabled>
                            <i class="fas fa-play me-1"></i> Run Analysis
                        </button>
                    </div>
                </div>
                <input type="hidden" name="rule_ids" id="selected-rule-ids">
            </form>
        </div>
    </div>
</div>

<!-- Rule Selection Modal -->
<div class="modal fade" id="ruleSelectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-tasks me-2"></i>Select Analysis Rules
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Filter Controls -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" placeholder="Search rules..." id="rule-search">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex flex-wrap gap-2">
                            <select class="form-select form-select-sm" style="width: 120px;" id="severity-filter">
                                <option value="">All Severity</option>
                                <option value="critical">Critical</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                                <option value="info">Info</option>
                            </select>
                            <select class="form-select form-select-sm" style="width: 120px;" id="tag-filter">
                                <option value="">All Tags</option>
                                {% for tag in tags %}
                                <option value="{{ tag.name }}">{{ tag.name }}</option>
                                {% endfor %}
                            </select>
                            <button class="btn btn-sm btn-outline-success" onclick="selectAllRules(true)">
                                <i class="fas fa-check-square me-1"></i> All
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="selectAllRules(false)">
                                <i class="fas fa-square me-1"></i> None
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Rules Table -->
                <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th width="40px"></th>
                                <th>Rule</th>
                                <th>Description</th>
                                <th>Severity</th>
                                <th>Tags</th>
                                <th>Logics</th>
                            </tr>
                        </thead>
                        <tbody id="rule-table-body">
                            {% for rule in rules %}
                            <tr class="rule-row" 
                                data-name="{{ rule.name|lower }}"
                                data-description="{{ rule.description|lower }}"
                                data-severity="{{ rule.severity|lower }}"
                                data-tags="{% for tag in rule.tags.all %}{{ tag.name|lower }} {% endfor %}">
                                <td>
                                    <input type="checkbox" class="form-check-input rule-checkbox" value="{{ rule.id }}">
                                </td>
                                <td>
                                    <strong>{{ rule.name }}</strong>
                                    <button class="btn btn-sm btn-link p-0 ms-1" 
                                            data-bs-toggle="tooltip" 
                                            data-bs-html="true"
                                            title="<strong>Expression:</strong><br><code>{{ rule.boolean_expression }}</code>">
                                        <i class="fas fa-info-circle text-info"></i>
                                    </button>
                                </td>
                                <td>{{ rule.description|truncatechars:60 }}</td>
                                <td>
                                    <span class="badge bg-{% if rule.severity == 'critical' %}danger{% elif rule.severity == 'high' %}warning{% elif rule.severity == 'medium' %}info{% elif rule.severity == 'low' %}secondary{% else %}light{% endif %}">
                                        {{ rule.severity|title }}
                                    </span>
                                </td>
                                <td>
                                    {% for tag in rule.tags.all %}
                                    <span class="badge bg-light text-dark border me-1">{{ tag.name }}</span>
                                    {% endfor %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" 
                                            type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#logics-{{ rule.id }}">
                                        {{ rule.logics.count }} logics
                                    </button>
                                </td>
                            </tr>
                            <tr class="collapse" id="logics-{{ rule.id }}">
                                <td colspan="6" class="bg-light">
                                    <div class="p-3">
                                        <div class="row">
                                            {% for logic in rule.logics.all %}
                                            <div class="col-md-6 mb-2">
                                                <div class="card border">
                                                    <div class="card-header py-2">
                                                        <strong>{{ logic.name }}</strong>
                                                        <span class="badge bg-{{ logic.negate|yesno:'warning,success' }} ms-2">
                                                            {{ logic.negate|yesno:'Negated,Positive' }}
                                                        </span>
                                                    </div>
                                                    <div class="card-body p-2">
                                                        <div class="mb-1"><strong>Method:</strong> <code>{{ logic.method }}</code></div>
                                                        <div class="mb-1"><strong>Pattern:</strong> <code>{{ logic.pattern|truncatechars:80 }}</code></div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="confirmRuleSelection()">
                    <i class="fas fa-check me-1"></i> Confirm Selection
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Analysis Progress Modal -->
<div class="modal fade" id="analysisProgressModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Analysis Progress</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="card">
                    <div class="card-body p-0">
                        <div id="analysis-status" class="p-3 mb-0" 
                             style="height: 300px; overflow-y: auto; font-family: monospace;"></div>
                    </div>
                </div>
                <div id="results-section" class="mt-3 d-none">
                    <h6>View Results:</h6>
                    <div id="result-buttons" class="d-flex flex-wrap gap-2"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Global variables to track current state
let currentIncidentFilter = 'all';
let isSearchActive = false;

// Safe element access helper
function getElementSafe(id) {
    const el = document.getElementById(id);
    if (!el) console.error(`Element with ID ${id} not found`);
    return el;
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Initialize select all checkbox
    const selectAllCheckbox = getElementSafe('select-all-checkbox');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            selectAllArtefacts(this.checked);
        });
    }

    // Initialize artefact search
    const artefactSearch = getElementSafe('artefact-search');
    if (artefactSearch) {
        artefactSearch.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            isSearchActive = searchTerm.length > 0;
            filterArtefacts();
        });
    }

    // Initialize rule search and filters
    const ruleSearch = getElementSafe('rule-search');
    const tagFilter = getElementSafe('tag-filter');
    const severityFilter = getElementSafe('severity-filter');

    if (ruleSearch) ruleSearch.addEventListener('input', filterRules);
    if (tagFilter) tagFilter.addEventListener('change', filterRules);
    if (severityFilter) severityFilter.addEventListener('change', filterRules);

    // Add event listeners to rule checkboxes
    document.querySelectorAll('.rule-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateRuleSelectionUI);
    });

    // Add event listeners to artefact checkboxes
    document.querySelectorAll('.artefact-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectAllCheckbox);
    });
});

// Enhanced artefact filtering
function filterArtefacts() {
    const searchTerm = getElementSafe('artefact-search')?.value.toLowerCase() || '';
    const rows = document.querySelectorAll('.artefact-row');
    
    rows.forEach(row => {
        const incidentId = row.dataset.incident;
        const text = row.textContent.toLowerCase();
        
        // Check if row matches incident filter
        const matchesIncident = currentIncidentFilter === 'all' || incidentId == currentIncidentFilter;
        
        // Check if row matches search term
        const matchesSearch = searchTerm === '' || text.includes(searchTerm);
        
        // Show row only if it matches both filters
        row.style.display = matchesIncident && matchesSearch ? '' : 'none';
    });
    
    // Update select all checkbox state
    updateSelectAllCheckbox();
}

// Incident filtering with proper state management
function filterByIncident(incidentId) {
    // Update current filter state
    currentIncidentFilter = incidentId;
    
    // Update UI - remove active class from all filter buttons
    document.querySelectorAll('.list-group-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Add active class to selected filter
    const activeFilter = incidentId === 'all' ? 
        getElementSafe('filter-all') : 
        getElementSafe(`filter-${incidentId}`);
    
    if (activeFilter) {
        activeFilter.classList.add('active');
    }
    
    // Apply filters
    filterArtefacts();
    
    // Clear any selections when changing incident filter
    document.querySelectorAll('.artefact-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Update select all checkbox
    updateSelectAllCheckbox();
}

// Enhanced select all functionality
function selectAllArtefacts(select) {
    const visibleCheckboxes = Array.from(document.querySelectorAll('.artefact-checkbox'))
        .filter(checkbox => {
            const row = checkbox.closest('.artefact-row');
            return row && row.style.display !== 'none';
        });
    
    visibleCheckboxes.forEach(checkbox => {
        checkbox.checked = select;
    });
    
    updateSelectAllCheckbox();
}

// Update select all checkbox state based on visible checkboxes
function updateSelectAllCheckbox() {
    const selectAllCheckbox = getElementSafe('select-all-checkbox');
    if (!selectAllCheckbox) return;
    
    const visibleCheckboxes = Array.from(document.querySelectorAll('.artefact-checkbox'))
        .filter(checkbox => {
            const row = checkbox.closest('.artefact-row');
            return row && row.style.display !== 'none';
        });
    
    if (visibleCheckboxes.length === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
        return;
    }
    
    const checkedCount = visibleCheckboxes.filter(cb => cb.checked).length;
    
    if (checkedCount === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedCount === visibleCheckboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    }
}

// Rule selection and filtering
function updateRuleSelectionUI() {
    const selectedRules = Array.from(document.querySelectorAll('.rule-checkbox:checked'));
    const selectedRuleIds = selectedRules.map(checkbox => checkbox.value);
    
    // Update hidden field
    const selectedRuleIdsEl = getElementSafe('selected-rule-ids');
    if (selectedRuleIdsEl) selectedRuleIdsEl.value = selectedRuleIds.join(',');
    
    // Update count display
    const selectedRuleCountEl = getElementSafe('selected-rule-count');
    if (selectedRuleCountEl) selectedRuleCountEl.textContent = selectedRules.length;
    
    // Update rule preview
    const container = getElementSafe('selected-rules-container');
    const runAnalysisBtn = getElementSafe('run-analysis-btn');
    
    if (container) {
        container.innerHTML = '';
        
        if (selectedRules.length === 0) {
            container.innerHTML = '<span class="text-muted">No rules selected</span>';
            if (runAnalysisBtn) runAnalysisBtn.disabled = true;
            return;
        }
        
        if (runAnalysisBtn) runAnalysisBtn.disabled = false;
        
        selectedRules.forEach(checkbox => {
            const row = checkbox.closest('tr');
            if (!row) return;
            
            const ruleName = row.querySelector('td:nth-child(2) strong')?.textContent;
            const severityBadge = row.querySelector('td:nth-child(4) .badge')?.cloneNode(true);
            
            if (!ruleName) return;
            
            const ruleElement = document.createElement('div');
            ruleElement.className = 'd-flex align-items-center border rounded p-2 mb-2';
            
            let badgeHtml = '';
            if (severityBadge) {
                severityBadge.classList.add('me-2');
                badgeHtml = severityBadge.outerHTML;
            }
            
            ruleElement.innerHTML = `
                ${badgeHtml}
                <strong class="me-2">${ruleName}</strong>
                <button class="btn btn-sm btn-outline-danger ms-auto" 
                        onclick="deselectRule('${checkbox.value}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(ruleElement);
        });
    }
}

function deselectRule(ruleId) {
    const checkbox = document.querySelector(`.rule-checkbox[value="${ruleId}"]`);
    if (checkbox) {
        checkbox.checked = false;
        updateRuleSelectionUI();
    }
}

function selectAllRules(select) {
    const visibleRules = Array.from(document.querySelectorAll('.rule-row'))
        .filter(row => row.style.display !== 'none');
    
    visibleRules.forEach(row => {
        const checkbox = row.querySelector('.rule-checkbox');
        if (checkbox) checkbox.checked = select;
    });
    
    updateRuleSelectionUI();
}

function confirmRuleSelection() {
    updateRuleSelectionUI();
    const modal = bootstrap.Modal.getInstance(getElementSafe('ruleSelectModal'));
    if (modal) modal.hide();
}

function filterRules() {
    const searchTerm = getElementSafe('rule-search')?.value.toLowerCase() || '';
    const tagFilterValue = getElementSafe('tag-filter')?.value.toLowerCase() || '';
    const severityFilterValue = getElementSafe('severity-filter')?.value.toLowerCase() || '';
    
    document.querySelectorAll('.rule-row').forEach(row => {
        const name = row.dataset.name || '';
        const description = row.dataset.description || '';
        const severity = row.dataset.severity || '';
        const tags = row.dataset.tags || '';
        
        const matchesSearch = searchTerm === '' || 
            name.includes(searchTerm) || 
            description.includes(searchTerm);
        
        const matchesTag = tagFilterValue === '' || 
            tags.includes(tagFilterValue);
        
        const matchesSeverity = severityFilterValue === '' || 
            severity.includes(severityFilterValue);
        
        row.style.display = matchesSearch && matchesTag && matchesSeverity ? '' : 'none';
        
        // Also hide/show the corresponding collapse row
        const collapseRow = document.querySelector(`#logics-${row.querySelector('.rule-checkbox')?.value}`);
        if (collapseRow) {
            collapseRow.style.display = row.style.display;
        }
    });
}

// Analysis execution with better error handling
function launchAnalysisModal(e) {
    e.preventDefault();
    
    const form = document.getElementById('analysis-form');
    const statusElement = document.getElementById('analysis-status');
    const runBtn = document.getElementById('run-analysis-btn');
    
    // Validate form
    const selectedArtefacts = document.querySelectorAll('.artefact-checkbox:checked');
    const selectedRules = document.querySelectorAll('.rule-checkbox:checked');
    
    if (selectedArtefacts.length === 0) {
        alert('Please select at least one artefact to analyze.');
        return;
    }
    
    if (selectedRules.length === 0) {
        alert('Please select at least one rule to apply.');
        return;
    }
    
    // Reset UI
    statusElement.innerHTML = '<p class="text-primary"><i class="fas fa-spinner fa-spin"></i> Starting analysis...</p>';
    runBtn.disabled = true;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('analysisProgressModal'));
    modal.show();
    
    // Start analysis
    const formData = new FormData(form);
    
    fetch("{% url 'analysis:run_analysis' %}", {
        method: "POST",
        headers: {"X-CSRFToken": formData.get('csrfmiddlewaretoken')},
        body: formData
    }).then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        if (!response.body) {
            throw new Error('No response body received');
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        function read() {
            return reader.read().then(({done, value}) => {
                if (done) {
                    statusElement.innerHTML += '<p class="text-success"><i class="fas fa-check-circle"></i> Analysis completed successfully!</p>';
                    runBtn.disabled = false;
                    return;
                }

                const text = decoder.decode(value, {stream: true});
                statusElement.innerHTML += text;

                // Limit content to prevent memory issues
                const lines = statusElement.innerHTML.split('\n');
                if (lines.length > 500) {
                    statusElement.innerHTML = lines.slice(-400).join('\n');
                }

                // Auto-scroll to bottom
                statusElement.scrollTop = statusElement.scrollHeight;

                return read();
            });
        }
        
        return read();
    }).catch(error => {
        console.error('Analysis error:', error);
        statusElement.innerHTML += `<p class="text-danger"><i class="fas fa-exclamation-triangle"></i> Error: ${error.message}</p>`;
        runBtn.disabled = false;
    });
}
</script>
{% endblock %}