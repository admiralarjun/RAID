<!-- templates/analysis/artefact_result.html -->
{% extends "base.html" %}
{% load widget_tweaks %}

{% block content %}
<div class="container-fluid my-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-0">
        <i class="fas fa-file-alt me-2 text-primary"></i>Analysis Results
      </h2>
      <p class="text-muted mb-0">{{ artefact.name }} â€” {{ artefact.incident.title }}</p>
    </div>
    <div>
      <a href="{% url 'analysis:start' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i> Back to Analysis
      </a>
    </div>
  </div>

  <!-- AI Summary -->
  <div class="card mb-4">
  <div class="card-header">
    <strong><i class="fas fa-robot me-1"></i> AI Analysis Summary</strong>
    <span class="float-end text-muted" style="font-size: 0.9em;">
      {{ ai_artefact_analysis_result.generated_at|date:"Y-m-d H:i" }}
    </span>
  </div>
  <div class="card-body">
    <p><strong>Artefact Type:</strong> {{ ai_artefact_analysis_result.artefact_type }}</p>

    <div class="mb-3">
      <strong>Summary:</strong>
      <p>{{ ai_artefact_analysis_result.summary }}</p>
    </div>

    <div class="mb-3">
      <strong>Narrative:</strong>
      <p>{{ ai_artefact_analysis_result.narrative }}</p>
    </div>

    {% if ai_artefact_analysis_result.highlights %}
    <div class="mb-3">
      <strong>Key Highlights:</strong>
      <div class="table-responsive">
      <table class="table table-bordered align-middle mb-0">
        <thead class="table-light">
        <tr>
          <th scope="col">Record</th>
          <th scope="col">Excerpt</th>
          <th scope="col">Reason</th>
        </tr>
        </thead>
        <tbody>
        {% for h in ai_artefact_analysis_result.highlights %}
        <tr>
          <td>
          <a href="{% url 'core:log_record_permalink' h.record_index %}" class="text-decoration-none">
            # {{ h.log_index }}
          </a>
          </td>
          <td class="fst-italic">{{ h.excerpt }}</td>
          <td class="text-success">{{ h.reason }}</td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
      </div>
    </div>
    {% endif %}

    {% if ai_artefact_analysis_result.references %}
    <div class="mb-3">
      <strong>Relevant Rule References:</strong>
      <ul class="list-group">
        {% for r in ai_artefact_analysis_result.references %}
        <li class="list-group-item">
          Rule: <strong>{{ r.rule_name }}</strong>
          <br>
          Match: <span class="text-muted">#{{ r.rule_match_id }}</span>,
          <a href="{% url 'core:log_record_permalink' r.record_index %}" class="text-decoration-none">
            <i class="fas fa-link text-primary me-1"></i>Record {{ r.log_index }}
          </a>
          {% if r.mitre_techniques %}
          <div class="mt-1">
            MITRE TTPs:
            {% for m in r.mitre_techniques %}
              <span class="badge bg-info text-dark">{{ m }}</span>
            {% endfor %}
          </div>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    {% if ai_artefact_analysis_result.recommendations %}
    <div class="mb-3">
      <strong>Recommendations:</strong>
      <ul class="list-group">
        {% for rec in ai_artefact_analysis_result.recommendations %}
        <li class="list-group-item">
          <i class="fas fa-check-circle text-success me-1"></i>{{ rec }}
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </div>
  </div>


  <!-- Summary Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <i class="fas fa-layer-group text-primary fa-2x mb-2"></i>
          <h4 class="mb-0">{{ total_matches }}</h4>
          <small class="text-muted">Total Matches</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <i class="fas fa-project-diagram text-info fa-2x mb-2"></i>
          <h4 class="mb-0">{{ unique_rules_count }}</h4>
          <small class="text-muted">Unique Rules</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <i class="fas fa-check text-success fa-2x mb-2"></i>
          <h4 class="mb-0">{{ status_counts.passed }}</h4>
          <small class="text-muted">Passed</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <i class="fas fa-times text-danger fa-2x mb-2"></i>
          <h4 class="mb-0">{{ status_counts.failed }}</h4>
          <small class="text-muted">Failed</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Form -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="fas fa-filter me-2"></i>Filters
      </h5>
    </div>
    <div class="card-body">
      <form method="get" id="filter-form">
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">Search</label>
            <input type="text" class="form-control" name="search" 
                   value="{{ current_search }}" 
                   placeholder="Search rules, descriptions, log content..."
                   onchange="this.form.submit()">
          </div>
          <div class="col-md-2 mb-3">
            <label class="form-label">Status</label>
            <select class="form-select" name="status" onchange="this.form.submit()">
              <option value="">All Status</option>
              <option value="passed" {% if current_status == 'passed' %}selected{% endif %}>Passed</option>
              <option value="failed" {% if current_status == 'failed' %}selected{% endif %}>Failed</option>
            </select>
          </div>
          <div class="col-md-2 mb-3">
            <label class="form-label">Tag</label>
            <select class="form-select" name="tag" onchange="this.form.submit()">
              <option value="">All Tags</option>
              {% for tag in available_tags %}
              <option value="{{ tag }}" {% if current_tag == tag %}selected{% endif %}>{{ tag }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2 mb-3">
            <label class="form-label">MITRE</label>
            <select class="form-select" name="mitre" onchange="this.form.submit()">
              <option value="">All Techniques</option>
              {% for technique_id, technique_name, technique_description in available_techniques %}
              <option value="{{ technique_id }}" {% if current_mitre == technique_id %}selected{% endif %} title="{{ technique_description }}">{{ technique_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2 mb-3">
            <label class="form-label">View</label>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" name="expand_all" value="1" 
                     {% if expand_all %}checked{% endif %} onchange="this.form.submit()">
              <label class="form-check-label">Expand All</label>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-auto">
            <a href="{% url 'analysis:artefact_result' artefact.pk %}" class="btn btn-outline-secondary btn-sm">
              <i class="fas fa-undo me-1"></i> Clear Filters
            </a>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Results -->
  {% include 'analysis/partials/matches_accordion.html' %}

  <!-- Pagination -->
  {% if page_obj.has_other_pages %}
  <nav aria-label="Results pagination">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if current_search %}&search={{ current_search }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}{% if current_tag %}&tag={{ current_tag }}{% endif %}{% if current_mitre %}&mitre={{ current_mitre }}{% endif %}{% if expand_all %}&expand_all=1{% endif %}">Previous</a>
        </li>
      {% endif %}
      
      {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
          <li class="page-item active">
            <span class="page-link">{{ num }}</span>
          </li>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
          <li class="page-item">
            <a class="page-link" href="?page={{ num }}{% if current_search %}&search={{ current_search }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}{% if current_tag %}&tag={{ current_tag }}{% endif %}{% if current_mitre %}&mitre={{ current_mitre }}{% endif %}{% if expand_all %}&expand_all=1{% endif %}">{{ num }}</a>
          </li>
        {% endif %}
      {% endfor %}
      
      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if current_search %}&search={{ current_search }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}{% if current_tag %}&tag={{ current_tag }}{% endif %}{% if current_mitre %}&mitre={{ current_mitre }}{% endif %}{% if expand_all %}&expand_all=1{% endif %}">Next</a>
        </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Minimal JavaScript - only for essential UX improvements
document.addEventListener('DOMContentLoaded', function() {
  // Auto-submit form after short delay when typing in search
  const searchInput = document.querySelector('input[name="search"]');
  let searchTimeout;
  
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        this.form.submit();
      }, 800); // Wait 800ms after user stops typing
    });
  }
  
  // Copy functionality
  window.copyContent = function(text) {
    navigator.clipboard.writeText(text).then(() => {
      // Simple toast
      const toast = document.createElement('div');
      toast.className = 'position-fixed top-0 end-0 m-3 alert alert-success alert-dismissible fade show';
      toast.style.zIndex = '9999';
      toast.innerHTML = 'Copied to clipboard! <button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    });
  };
});
</script>
{% endblock %}