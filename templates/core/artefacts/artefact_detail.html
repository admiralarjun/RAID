{% extends 'base.html' %}
{% load static utils crispy_forms_tags %}

{% block title %}Artefact Detail{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <div class="row" id="split-container" style="display: flex; height: 50vh; max-height: 50vh;">
    <!-- Left Pane: Notes -->
    <div id="notes-pane" style="flex: 0 0 35%; min-width: 200px; border-right: 1px solid #dee2e6; overflow-y: auto; padding: 0 1rem; display: flex; flex-direction: column;">
      <div style="flex-shrink: 0;">
        <h5 class="mb-3">Notes</h5>
        <form method="post" action="{% url 'core:add_artefact_note' %}">
          {% csrf_token %}
          <input type="hidden" name="artefact_id" value="{{ artefact.id }}">
          <textarea name="content" rows="4" class="form-control mb-2" placeholder="Add a note using Markdown. You can refer to logs using #record_number."></textarea>
          <button type="submit" class="btn btn-primary btn-sm">Save Note</button>
        </form>
        <hr>
      </div>
      
      <div style="overflow-y: auto; flex-grow: 1;">
        {% for note in notes %}
          {% include "core/artefacts/partials/_note_entry.html" %}
        {% empty %}
          <p class="text-muted">No notes yet.</p>
        {% endfor %}
      </div>
    </div>

    <!-- Drag handle -->
    <div id="drag-handle" style="width: 2px; cursor: col-resize; background: #444444;"></div>

    <!-- Right Pane: Logs + Filters -->
    <div id="logs-pane" style="flex: 1 1 0; min-width: 0; display: flex; flex-direction: column; overflow: hidden;">
      <div style="flex-shrink: 0;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5>{{ artefact.name }} â€” Logs</h5>
          <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse">
            Filter
          </button>
        </div>

        <div id="filterCollapse" class="collapse mb-3">
          <form method="get" class="card card-body">
            <div id="filter-conditions" class="row g-2">
              {% for f in applied_filters %}
                {% with f|split:":" as parts %}
                <div class="col-md-6 d-flex">
                  <select name="filter" class="form-select form-select-sm me-1">
                    <option value="contains:{{ parts.1 }}" {% if parts.0 == "contains" %}selected{% endif %}>Contains</option>
                    <option value="notcontains:{{ parts.1 }}" {% if parts.0 == "notcontains" %}selected{% endif %}>Does not contain</option>
                  </select>
                  <input type="text" name="filter" value="{{ parts.1 }}" class="form-control form-control-sm" placeholder="Text">
                </div>
                {% endwith %}
              {% empty %}
                <div class="col-md-6 d-flex">
                  <select name="filter" class="form-select form-select-sm me-1">
                    <option value="contains:">Contains</option>
                    <option value="notcontains:">Does not contain</option>
                  </select>
                  <input type="text" name="filter" class="form-control form-control-sm" placeholder="Text">
                </div>
              {% endfor %}
            </div>
            <div class="mt-3">
              <button type="submit" class="btn btn-sm btn-primary">Apply Filters</button>
              <button type="button" onclick="addFilter()" class="btn btn-sm btn-outline-secondary">+ Add Filter</button>
              <a href="?" class="btn btn-sm btn-link text-danger">Clear</a>
            </div>
          </form>
        </div>
      </div>
      
      <div style="overflow-y: auto; flex-grow: 1;">
        <ul class="list-group" id="log-list">
          {% for record in records %}
            {% include "core/artefacts/partials/_record_entry.html" %}
          {% empty %}
            <li class="list-group-item text-muted">No records found.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
function addFilter() {
  const container = document.getElementById('filter-conditions');
  const div = document.createElement('div');
  div.className = "col-md-6 d-flex mt-2";
  div.innerHTML = `
    <select name="filter" class="form-select form-select-sm me-1">
      <option value="contains:">Contains</option>
      <option value="notcontains:">Does not contain</option>
    </select>
    <input type="text" name="filter" class="form-control form-control-sm" placeholder="Text">
  `;
  container.appendChild(div);
}

// Split drag bar
let isDragging = false;
const handle = document.getElementById('drag-handle');
const notesPane = document.getElementById('notes-pane');
const logsPane = document.getElementById('logs-pane');
const splitContainer = document.getElementById('split-container');

handle.addEventListener('mousedown', function(e) {
  isDragging = true;
  document.body.style.cursor = 'col-resize';
  document.addEventListener('mousemove', handleDrag);
  document.addEventListener('mouseup', stopDrag);
});

function handleDrag(e) {
  if (!isDragging) return;
  
  e.preventDefault();
  
  const containerRect = splitContainer.getBoundingClientRect();
  let leftWidth = e.clientX - containerRect.left;
  const minLeft = 150;
  const maxLeft = containerRect.width - 150;
  
  leftWidth = Math.max(minLeft, Math.min(leftWidth, maxLeft));
  
  notesPane.style.flex = `0 0 ${leftWidth}px`;
  logsPane.style.flex = `1 1 0`;
}

function stopDrag() {
  isDragging = false;
  document.body.style.cursor = '';
  document.removeEventListener('mousemove', handleDrag);
  document.removeEventListener('mouseup', stopDrag);
}

// Initialize with proper split
document.addEventListener('DOMContentLoaded', function() {
  const initialWidth = splitContainer.clientWidth * 0.35;
  notesPane.style.flex = `0 0 ${initialWidth}px`;
});
</script>

<style>
  #drag-handle:hover {
    background: #aaa;
  }
  
  #split-container {
    position: relative;
  }
  
  #log-list {
    overflow-anchor: none;
  }
  
  #notes-pane > div:first-child,
  #logs-pane > div:first-child {
    padding-top: 1rem;
    padding-bottom: 1rem;
  }
  
  #notes-pane, #logs-pane {
    height: 100%;
  }
</style>
{% endblock %}