{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="card shadow-sm border-0">
    <div class="card-body">
      <h4 class="card-title mb-3">Upload Artefacts</h4>
      <p class="text-muted">Assign each artefact to a responder before uploading.</p>

      {% if success %}
        <div class="bg-success bg-opacity-10 border border-success rounded p-3 d-flex justify-content-between align-items-center mb-3">
          <span class="text-success fw-semibold"><strong>Success!</strong> Artefacts uploaded.</span>
          <a href="{% url 'core:incident_detail' incident.incident_id %}" class="btn btn-sm btn-outline-primary">
            View Incident
          </a>
        </div>
      {% endif %}

      <form method="post" enctype="multipart/form-data" id="upload-form">
        {% csrf_token %}
        <div class="row">
          <div class="col-md-6">
            {{ form|crispy }}
          </div>
          <div class="col-md-6">
            <label for="file" class="form-label">Select Files</label>
            <input type="file" name="file" id="file" class="form-control" multiple required>
          </div>
        </div>

        <div id="file-preview" class="mt-4" style="display:none;">
          <h6 class="fw-bold">Review and Assign</h6>
          <table class="table table-sm align-middle table-bordered">
            <thead class="table-light">
              <tr>
                <th>Filename</th>
                <th>Assign To</th>
              </tr>
            </thead>
            <tbody id="file-preview-body"></tbody>
          </table>
        </div>

        <div class="mt-3 text-end">
          <button type="submit" class="btn btn-primary">Upload Artefacts</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const userOptions = `
    {% for user in users %}
      <option value="{{ user.id }}">{{ user.username }}</option>
    {% endfor %}
  `;

  document.getElementById('file').addEventListener('change', function () {
    const files = this.files;
    const previewBody = document.getElementById('file-preview-body');
    previewBody.innerHTML = '';
    [...files].forEach((file, idx) => {
      previewBody.innerHTML += `
        <tr>
          <td>${file.name}</td>
          <td>
            <select name="assigned_to_${idx}" class="form-select form-select-sm">
              <option value="">Unassigned</option>
              ${userOptions}
            </select>
          </td>
        </tr>
      `;
    });
    document.getElementById('file-preview').style.display = files.length ? 'block' : 'none';
  });
</script>
{% endblock %}
