{% extends "base.html" %}
{% load utils %}

{% block content %}
<div class="container-fluid py-3">
  <!-- Full-Width Header -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-start">
        <div class="flex-fill">
          <div class="d-flex align-items-center gap-2 mb-1">
            <i class="fa fa-exclamation-triangle text-warning"></i>
            <h1 class="mb-0">{{ object.title }}</h1>
            <span class="badge bg-{{ object.status|yesno:"success,warning,danger" }} ms-2">{{ object.get_status_display }}</span>
            <span class="badge bg-{{ object.severity|yesno:"danger,warning,info" }}">{{ object.get_severity_display }}</span>
            <div>
              <a href="{% url 'core:incident_export_pdf' incident.incident_id %}" target="_blank" class="btn btn-outline-primary btn-sm">
                  <i class="fa fa-file-pdf"></i> Export PDF
              </a>
              <a href="{% url 'core:incident_export_csv' incident.incident_id %}" target="_blank" class="btn btn-outline-secondary btn-sm">
                  <i class="fa fa-file-csv"></i> Export CSV
              </a>
            </div>
          </div>
          <small class="text-muted">#{{ object.incident_id }} | {{ object.client.name }}</small>
        </div>
        <div class="btn-group">
          <a href="{% url 'core:incident_update' object.pk %}" class="btn btn-warning btn-sm">
            <i class="fa fa-edit"></i> Edit
          </a>
          <a href="{% url 'core:incident_list' %}" class="btn btn-secondary btn-sm">
            <i class="fa fa-arrow-left"></i> Back
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Full-Width Team Info -->
  <div class="row mb-3">
    <div class="col-md-4">
      <small class="text-muted">Manager:</small> <strong>{{ object.incident_manager }}</strong>
    </div>
    <div class="col-md-4">
      <small class="text-muted">Lead:</small> <strong>{{ object.lead_responder|default:"—" }}</strong>
    </div>
    <div class="col-md-4">
      <small class="text-muted">Responders:</small> <strong>{{ object.responders.all|join:", "|default:"—" }}</strong>
    </div>
  </div>


    <!-- Full-Width Incident Analysis -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header py-2">
          <h6 class="mb-0"><i class="fa fa-brain me-2"></i>Incident Analysis</h6>
        </div>
        <div class="card-body">
          {% if incident_ai %}
          
              <h6>Summary</h6>
              <p>{{ incident_ai.summary }}</p>
              <small class="text-muted">Generated: {{ incident_ai.generated_at|date:"M d, H:i" }}</small>
            </div>
      
          </div>
          {% else %}
          <div class="text-center text-muted py-4">
            <i class="fa fa-cog fa-3x mb-3"></i>
            <h6>Incident AI Analysis Not Run Yet</h6>
            <p class="mb-3">Run AI analysis to get incident-level insights and recommendations.</p>
            <a href="{% url 'analysis:start' %}" class="btn btn-primary btn-sm">
              <i class="fa fa-play"></i> Start Analysis
            </a>
          </div>
          {% endif %}
        </div>
  </div>

  <!-- Full-Width Artefacts Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
          <h6 class="mb-0"><i class="fa fa-archive me-2"></i>Artefacts ({{ object.artefacts.count }})</h6>
          <a href="{% url 'core:artefact_create' %}?incident={{ object.pk }}" class="btn btn-success btn-sm">
            <i class="fa fa-plus"></i> Add Artefact
          </a>
        </div>
        <div class="card-body p-0">
          {% if object.artefacts.exists %}
          <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Name</th>
                  <th>Type</th>
                  <th>Uploader</th>
                  <th>Assigned</th>
                  <th>Uploaded</th>
                  <th>AI Status</th>
                  <th width="150">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for art in object.artefacts.all %}
                <tr>
                  <td><strong>{{ art.name }}</strong></td>
                  <td><span class="badge bg-light text-dark">{{ art.get_artefact_type_display }}</span></td>
                  <td>{{ art.uploaded_by }}</td>
                  <td>{{ art.assigned_to|default:"—" }}</td>
                  <td><small>{{ art.uploaded_at|date:"M d, H:i" }}</small></td>
                  <td>
                    {% with ai=artefact_ai|dict_get:art.id %}
                      {% if ai %}
                        <span class="badge bg-success">Analyzed</span>
                      {% else %}
                        <span class="badge bg-secondary">Pending</span>
                      {% endif %}
                    {% endwith %}
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <a href="{% url 'core:artefact_detail' art.pk %}" class="btn btn-outline-primary btn-sm">
                        <i class="fa fa-eye"></i>
                      </a>
                      {% with ai=artefact_ai|dict_get:art.id %}
                        {% if ai %}
                          <a href="{% url 'analysis:artefact_result' art.id %}" class="btn btn-outline-info btn-sm">
                            <i class="fa fa-brain"></i>
                          </a>
                        {% else %}
                          <a href="{% url 'analysis:start' %}" class="btn btn-outline-primary btn-sm">
                            <i class="fa fa-robot"></i>
                          </a>
                        {% endif %}
                      {% endwith %}
                      <a href="{% url 'core:artefact_delete' art.pk %}?next={% url 'core:incident_detail' object.incident_id %}" 
                         class="btn btn-outline-danger btn-sm">
                        <i class="fa fa-trash"></i>
                      </a>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="p-4 text-center text-muted">
            <i class="fa fa-inbox fa-2x mb-2"></i>
            <p class="mb-2">No artefacts uploaded yet.</p>
            <a href="{% url 'core:artefact_create' %}?incident={{ object.pk }}" class="btn btn-success btn-sm">
              <i class="fa fa-plus"></i> Upload First Artefact
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>


<!-- Full-Width AI Analysis Summary -->
{% if object.artefacts.exists %}
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header py-2 d-flex justify-content-between align-items-center">
        <h6 class="mb-0">
          <i class="fa fa-robot me-2"></i>Artefact Analysis
        </h6>
        <a href="{% url 'analysis:start' %}" class="btn btn-sm btn-outline-primary">
          <i class="fa fa-play me-1"></i> Re-run Analysis
        </a>
      </div>
      <div class="card-body">
        {% with count=object.artefacts.count %}
          {% if count > 0 %}
          <ul class="list-group list-group-flush">
            {% for art in object.artefacts.all %}
              {% with ai=artefact_ai|dict_get:art.id %}
                {% if ai %}
                <li class="list-group-item">
                  <div class="d-flex justify-content-between align-items-start flex-wrap">
                    <div class="me-3">
                      <h5 class="mb-1">{{ art.name }}</h5>
                      <p class="small text-muted mb-1">{{ art.get_artefact_type_display }}</p>
                      <p class="mb-1">{{ ai.summary|truncatechars:150 }}</p>
                    </div>
                    <div class="mt-2">
                      <a href="{% url 'analysis:artefact_result' art.id %}" class="btn btn-sm btn-outline-primary">
                        View Full Analysis
                      </a>
                    </div>
                  </div>
                </li>
                <hr class="my-0">
                {% endif %}
              {% endwith %}
            {% empty %}
              <li class="list-group-item text-center text-muted">
                <i class="fa fa-robot fa-2x mb-2"></i>
                <p class="mb-2">No AI analysis available yet.</p>
              </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="text-center text-muted py-4">
            <i class="fa fa-robot fa-2x mb-2"></i>
            <p class="mb-2">No AI analysis available yet.</p>
            <a href="{% url 'analysis:start' %}" class="btn btn-primary btn-sm">
              <i class="fa fa-play"></i> Start AI Analysis
            </a>
          </div>
          {% endif %}
        {% endwith %}
      </div>
    </div>
  </div>
</div>
{% endif %}


<!-- Correlation Graph -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card" style="box-shadow: var(--shadow-deep); border-radius: 0; clip-path: var(--cut-diagonal);">
      <div class="card-header py-2 d-flex justify-content-between align-items-center" style="background-color: var(--dark-bg); color: var(--text-accent); text-shadow: var(--glow-primary);">
        <h6 class="mb-0">
          <i class="fa fa-project-diagram me-2"></i>Artefact Correlation Graph
        </h6>
      </div>
      <div class="card-body p-0" style="background-color: var(--dark-bg); border-top: 2px solid var(--neon-blue);">
        <div id="cy" style="width: 100%; height: 500px;"></div>
      </div>
    </div>
  </div>
</div>



<script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const graphData = {{ incident_ai.graph|safe }};

    const elements = [];

    graphData.nodes.forEach(node => {
      elements.push({
        data: { id: node.id, label: node.label, type: node.type }
      });
    });

    graphData.edges.forEach(edge => {
      elements.push({
        data: { source: edge.source, target: edge.target, label: edge.relationship || '' }
      });
    });

    const cy = cytoscape({
      container: document.getElementById('cy'),
      elements: elements,
      layout: {
        name: 'cose',
        fit: true,
        padding: 50,
        nodeRepulsion: 800000,
        idealEdgeLength: 200,
        edgeElasticity: 100,
        gravity: 80,
        numIter: 1000,
        coolingFactor: 0.99
      },
      style: [
        {
          selector: 'node',
          style: {
            'label': 'data(label)',
            'font-size': 20,
            'text-valign': 'center',
            'color': 'white',
            'background-color': 'whitesmoke',
            'border-color': '#f8f9fa',
            'border-width': 2,
            'width': 50,
            'height': 50,
            'text-wrap': 'wrap',
            'text-outline-color': 'black',
            'text-outline-width': 1
          }
        },
        {
          selector: 'edge',
          style: {
            'width': 2,
            'line-color': '#00d4ff',
            'target-arrow-color': '#ff0080',
            'target-arrow-shape': 'triangle',
            'curve-style': 'bezier',
            'label': 'data(label)',
            'font-size': 15,
            'color': 'whitesmoke',
            'text-outline-color': '#00ffff',
            'text-outline-width': 0.5
          }
        }
      ]
    });
  });
</script>





  <!-- Full-Width Hypotheses and Actions -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header py-2">
          <h6 class="mb-0"><i class="fa fa-lightbulb me-2"></i>Hypotheses</h6>
        </div>
        <div class="card-body p-0">
          {% if hypotheses %}
          <div class="list-group list-group-flush">
            {% for h in hypotheses %}
            <div class="list-group-item">
              <div class="d-flex w-100 justify-content-between">
                <h4 class="mb-1">Hypothesis #{{ forloop.counter }}</h4>
              </div>
              <p class="mb-1">{{ h.description }}</p>
              <small class="text-muted">
                {% if h.artefacts %}Artefacts: {{ h.artefacts|join:", " }} | {% endif %}
                {% if h.mitre_techniques %}MITRE: {{ h.mitre_techniques|join:", " }}{% endif %}
              </small>
            </div>
            <hr>
            {% endfor %}
          </div>
          {% else %}
          <div class="p-4 text-center text-muted">
            <i class="fa fa-lightbulb fa-2x mb-2"></i>
            <p class="mb-2">No hypotheses generated yet.</p>
            <a href="{% url 'analysis:start' %}" class="btn btn-outline-primary btn-sm">
              <i class="fa fa-magic"></i> Generate Hypotheses
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header py-2">
          <h6 class="mb-0"><i class="fa fa-tasks me-2"></i>Actions</h6>
        </div>
        <div class="card-body p-0">
          {% if actions %}
          <div class="list-group list-group-flush">
            {% for act in actions %}
            <div class="list-group-item d-flex justify-content-between align-items-start">
              <div class="ms-2 me-auto">
                <div class="fw-bold">{{ act.description }}</div>
              </div>
              <span class="badge bg-{{ act.status|yesno:"success,warning,secondary" }} rounded-pill">
                {{ act.get_status_display }}
              </span>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="p-4 text-center text-muted">
            <i class="fa fa-clipboard-list fa-2x mb-2"></i>
            <p class="mb-2">No actions defined yet.</p>
            <a href="{% url 'analysis:start' %}" class="btn btn-outline-primary btn-sm">
              <i class="fa fa-plus"></i> Create Actions
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}